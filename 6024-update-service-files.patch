From 74df2457ac1f91fa752d3143e2e6b6f99b67a0a8 Mon Sep 17 00:00:00 2001
From: openEuler Buildteam <buildteam@openeuler.org>
Date: Wed, 8 Jan 2020 03:26:02 -0500
Subject: [PATCH] update service files

---
 etc/systemd/iscsi.service    | 18 ++++++++++++++++++
 etc/systemd/iscsid.service   | 14 +++++++++-----
 etc/systemd/iscsid.socket    |  2 +-
 etc/systemd/iscsiuio.service | 19 +++++++++++++++++++
 etc/systemd/iscsiuio.socket  |  9 +++++++++
 5 files changed, 56 insertions(+), 6 deletions(-)
 create mode 100644 etc/systemd/iscsi.service
 create mode 100644 etc/systemd/iscsiuio.service
 create mode 100644 etc/systemd/iscsiuio.socket

diff --git a/etc/systemd/iscsi.service b/etc/systemd/iscsi.service
new file mode 100644
index 0000000..e475888
--- /dev/null
+++ b/etc/systemd/iscsi.service
@@ -0,0 +1,18 @@
+[Unit]
+Description=Login and scanning of iSCSI devices
+Documentation=man:iscsiadm(8) man:iscsid(8)
+Before=remote-fs.target
+After=network.target network-online.target iscsid.service
+Requires=iscsid.service
+ConditionPathExists=/etc/iscsi/initiatorname.iscsi
+
+[Service]
+Type=oneshot
+ExecStart=/sbin/iscsiadm -m node --loginall=automatic
+ExecStop=/sbin/iscsiadm -m node --logoutall=automatic
+ExecStop=/sbin/iscsiadm -m node --logoutall=manual
+SuccessExitStatus=21
+RemainAfterExit=true
+
+[Install]
+WantedBy=remote-fs.target
diff --git a/etc/systemd/iscsid.service b/etc/systemd/iscsid.service
index 028e0b3..4fef168 100644
--- a/etc/systemd/iscsid.service
+++ b/etc/systemd/iscsid.service
@@ -1,13 +1,17 @@
 [Unit]
 Description=Open-iSCSI
 Documentation=man:iscsid(8) man:iscsiuio(8) man:iscsiadm(8)
-After=network.target NetworkManager-wait-online.service iscsiuio.service tgtd.service targetcli.service
+DefaultDependencies=no
+DefaultDependencies=no
+After=network.target iscsiuio.service
+Before=remote-fs-pre.target
 
 [Service]
-Type=forking
-PIDFile=/var/run/iscsid.pid
-ExecStart=/usr/sbin/iscsid
-ExecStop=/sbin/iscsiadm -k 0 2
+Type=notify
+NotifyAccess=main
+ExecStart=/sbin/iscsid -f
+KillMode=mixed
+Restart=on-failure
 
 [Install]
 WantedBy=multi-user.target
+Also=iscsid.socket
diff --git a/etc/systemd/iscsid.socket b/etc/systemd/iscsid.socket
index 832451d..58a8d12 100644
--- a/etc/systemd/iscsid.socket
+++ b/etc/systemd/iscsid.socket
@@ -1,6 +1,6 @@
 [Unit]
 Description=Open-iSCSI iscsid Socket
-Documentation=man:iscsid(8) man:iscsiuio(8) man:iscsiadm(8)
+Documentation=man:iscsid(8) man:iscsiadm(8)
 
 [Socket]
 ListenStream=@ISCSIADM_ABSTRACT_NAMESPACE
diff --git a/etc/systemd/iscsiuio.service b/etc/systemd/iscsiuio.service
new file mode 100644
index 0000000..e4d9fd0
--- /dev/null
+++ b/etc/systemd/iscsiuio.service
@@ -0,0 +1,19 @@
+[Unit]
+Description=iSCSI UserSpace I/O driver
+Documentation=man:iscsiuio(8)
+DefaultDependencies=no
+Conflicts=shutdown.target
+Requires=iscsid.service
+BindTo=iscsid.service
+After=network.target
+Before=remote-fs-pre.target iscsid.service
+
+[Service]
+Type=notify
+NotifyAccess=main
+ExecStart=/sbin/iscsiuio -f
+KillMode=mixed
+Restart=on-failure
+
+[Install]
+WantedBy=multi-user.target
diff --git a/etc/systemd/iscsiuio.socket b/etc/systemd/iscsiuio.socket
new file mode 100644
index 0000000..d42cedc
--- /dev/null
+++ b/etc/systemd/iscsiuio.socket
@@ -0,0 +1,9 @@
+[Unit]
+Description=Open-iSCSI iscsiuio Socket
+Documentation=man:iscsiuio(8)
+
+[Socket]
+ListenStream=@ISCSID_UIP_ABSTRACT_NAMESPACE
+
+[Install]
+WantedBy=sockets.target
-- 
1.8.3.1

